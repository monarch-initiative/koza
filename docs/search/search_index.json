{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Koza - a data transformation framework","text":""},{"location":"#overview","title":"Overview","text":"<p>Koza is a data transformation framework which allows you to write semi-declarative \"ingests\"</p> <ul> <li>Transform csv, json, yaml, jsonl, or xml source data, converting them to a target csv, json, or jsonl format based on your dataclass model.  </li> <li>Koza also can output data in the KGX format</li> <li>Write data transforms in semi-declarative Python</li> <li>Configure source files, expected columns/json properties and path filters, field filters, and metadata in yaml</li> <li>Create or import mapping files to be used in ingests (eg. id mapping, type mappings)</li> <li>Create and use translation tables to map between source and target vocabularies</li> </ul>"},{"location":"#installation","title":"Installation","text":"<p>Koza is available on PyPi and can be installed via pip: <pre><code>pip install koza\n</code></pre></p>"},{"location":"#usage","title":"Usage","text":"<p>See the Ingests page for information on how to configure ingests for koza to use.</p> <p>Koza can be used as a Python library, or via the command line. CLI commands are available for validating and transforming data. See the API page for information on using Koza as a library.</p> <p>Koza also includes some examples to help you get started (see <code>koza/examples</code>).</p>"},{"location":"#basic-examples","title":"Basic Examples","text":"<p>Validate</p> <p>Give Koza a local or remote csv file, and get some basic information (headers, number of rows)</p> <pre><code>koza validate \\\n  --file ./examples/data/string.tsv \\\n  --delimiter ' '\n</code></pre> <p>Sending a json or jsonl formatted file will confirm if the file is valid json or jsonl</p> <pre><code>koza validate \\\n  --file ./examples/data/ZFIN_PHENOTYPE_0.jsonl.gz \\\n  --format jsonl\n</code></pre> <pre><code>koza validate \\\n  --file ./examples/data/ddpheno.json.gz \\\n  --format json \\\n  --compression gzip\n</code></pre> <p>Transform</p> <p>Try one of Koza's example ingests: <pre><code>koza transform \\\n  --source examples/string-declarative/protein-links-detailed.yaml \\\n  --global-table examples/translation_table.yaml\n</code></pre></p> <p>Note:    Koza expects a directory structure as described in the above example   with the source config file and transform code in the same directory:    <pre><code>.\n\u251c\u2500\u2500 ...\n\u2502   \u251c\u2500\u2500 some_source\n\u2502   \u2502   \u251c\u2500\u2500 your_ingest.yaml\n\u2502   \u2502   \u2514\u2500\u2500 your_ingest.py\n\u2502   \u2514\u2500\u2500 some_translation_table.yaml\n\u2514\u2500\u2500 ...\n</code></pre></p>"},{"location":"Usage/API/","title":"API","text":"<p>Module for managing koza runs through the CLI</p>"},{"location":"Usage/API/#src.koza.cli_runner.get_koza_app","title":"<code>get_koza_app</code>","text":"<p>Return a KozaApp object for a given source</p> <p>Parameters:</p> Name Type Description Default <code>source_name</code> <code>str</code> <p>Name of source</p> required Source code in <code>src/koza/cli_runner.py</code> <pre><code>def get_koza_app(source_name) -&gt; Optional[KozaApp]:\n    \"\"\"Return a KozaApp object for a given source\n\n    Args:\n        source_name (str): Name of source\n    \"\"\"\n    try:\n        return koza_apps[source_name]\n    except:\n        raise KeyError(f\"{source_name} was not found in KozaApp dictionary\")\n</code></pre>"},{"location":"Usage/API/#src.koza.cli_runner.get_translation_table","title":"<code>get_translation_table</code>","text":"<p>Create a translation table object from two file paths</p> <p>Parameters:</p> Name Type Description Default <code>global_table</code> <code>str</code> <p>Path to global translation table. Defaults to None.</p> <code>None</code> <code>local_table</code> <code>str</code> <p>Path to local translation table. Defaults to None.</p> <code>None</code> <p>Returns:</p> Name Type Description <code>TranslationTable</code> <code>TranslationTable</code> <p>TranslationTable object</p> Source code in <code>src/koza/cli_runner.py</code> <pre><code>def get_translation_table(\n    global_table: Union[str, Dict] = None,\n    local_table: Union[str, Dict] = None,\n    logger=None,\n) -&gt; TranslationTable:\n    \"\"\"Create a translation table object from two file paths\n\n    Args:\n        global_table (str, optional): Path to global translation table. Defaults to None.\n        local_table (str, optional): Path to local translation table. Defaults to None.\n\n    Returns:\n        TranslationTable: TranslationTable object\n    \"\"\"\n\n    global_tt = {}\n    local_tt = {}\n\n    if not global_table:\n        if local_table:\n            raise ValueError(\"Local table without a global table not allowed\")\n        else:\n            logger.debug(\"No global table used for transform\")\n    else:\n        if isinstance(global_table, str):\n            with open(global_table, 'r') as global_tt_fh:\n                global_tt = yaml.safe_load(global_tt_fh)\n        elif isinstance(global_table, Dict):\n            global_tt = global_table\n\n        if local_table:\n            if isinstance(local_table, str):\n                with open(local_table, 'r') as local_tt_fh:\n                    local_tt = yaml.safe_load(local_tt_fh)\n            elif isinstance(local_table, Dict):\n                local_tt = local_table\n\n        else:\n            logger.debug(\"No local table used for transform\")\n\n    return TranslationTable(global_tt, local_tt)\n</code></pre>"},{"location":"Usage/API/#src.koza.cli_runner.test_koza","title":"<code>test_koza</code>","text":"<p>Manually sets KozaApp (for testing)</p> Source code in <code>src/koza/cli_runner.py</code> <pre><code>def test_koza(koza: KozaApp):\n    \"\"\"Manually sets KozaApp (for testing)\"\"\"\n    global koza_app\n    koza_app = koza\n</code></pre>"},{"location":"Usage/API/#src.koza.cli_runner.transform_source","title":"<code>transform_source</code>","text":"<p>Create a KozaApp object, process maps, and run the transform</p> <p>Parameters:</p> Name Type Description Default <code>source</code> <code>str</code> <p>Path to source metadata file</p> required <code>output_dir</code> <code>str</code> <p>Path to output directory</p> required <code>output_format</code> <code>OutputFormat</code> <p>Output format. Defaults to OutputFormat('tsv').</p> <code>OutputFormat('tsv')</code> <code>global_table</code> <code>str</code> <p>Path to global translation table. Defaults to None.</p> <code>None</code> <code>local_table</code> <code>str</code> <p>Path to local translation table. Defaults to None.</p> <code>None</code> <code>schema</code> <code>str</code> <p>Path to schema file. Defaults to None.</p> <code>None</code> <code>row_limit</code> <code>int</code> <p>Number of rows to process. Defaults to None.</p> <code>None</code> <code>verbose</code> <code>bool</code> <p>Verbose logging. Defaults to None.</p> <code>None</code> <code>log</code> <code>bool</code> <p>Log to file. Defaults to False.</p> <code>False</code> Source code in <code>src/koza/cli_runner.py</code> <pre><code>def transform_source(\n    source: str,\n    output_dir: str,\n    output_format: OutputFormat = OutputFormat('tsv'),\n    global_table: str = None,\n    local_table: str = None,\n    schema: str = None,\n    row_limit: int = None,\n    verbose: bool = None,\n    log: bool = False,\n):\n    \"\"\"Create a KozaApp object, process maps, and run the transform\n\n    Args:\n        source (str): Path to source metadata file\n        output_dir (str): Path to output directory\n        output_format (OutputFormat, optional): Output format. Defaults to OutputFormat('tsv').\n        global_table (str, optional): Path to global translation table. Defaults to None.\n        local_table (str, optional): Path to local translation table. Defaults to None.\n        schema (str, optional): Path to schema file. Defaults to None.\n        row_limit (int, optional): Number of rows to process. Defaults to None.\n        verbose (bool, optional): Verbose logging. Defaults to None.\n        log (bool, optional): Log to file. Defaults to False.\n    \"\"\"\n    logger = get_logger(name=Path(source).name if log else None, verbose=verbose)\n\n    with open(source, 'r') as source_fh:\n        source_config = PrimaryFileConfig(**yaml.load(source_fh, Loader=UniqueIncludeLoader))\n\n    if not source_config.name:\n        source_config.name = Path(source).stem\n\n    if not source_config.transform_code:\n        # look for it alongside the source conf as a .py file\n        source_config.transform_code = str(Path(source).parent / Path(source).stem) + '.py'\n\n    koza_source = Source(source_config, row_limit)\n    logger.debug(f\"Source created: {koza_source.config.name}\")\n    translation_table = get_translation_table(\n        global_table if global_table else source_config.global_table,\n        local_table if local_table else source_config.local_table,\n        logger,\n    )\n\n    koza_app = _set_koza_app(koza_source, translation_table, output_dir, output_format, schema, logger)\n    koza_app.process_maps()\n    koza_app.process_sources()\n</code></pre>"},{"location":"Usage/API/#src.koza.cli_runner.validate_file","title":"<code>validate_file</code>","text":"<p>Runs a file through one of the Koza readers For csv files will return header and row length</p> <p>For json and jsonl just validates them</p> Source code in <code>src/koza/cli_runner.py</code> <pre><code>def validate_file(\n    file: str,\n    format: FormatType = FormatType.csv,\n    delimiter: str = ',',\n    header_delimiter: str = None,\n    skip_blank_lines: bool = True,\n):\n    \"\"\"\n    Runs a file through one of the Koza readers\n    For csv files will return header and row length\n\n    For json and jsonl just validates them\n    \"\"\"\n\n    with open_resource(file) as resource_io:\n        if format == FormatType.csv:\n            reader = CSVReader(\n                resource_io,\n                delimiter=delimiter,\n                header_delimiter=header_delimiter,\n                skip_blank_lines=skip_blank_lines,\n            )\n        elif format == FormatType.jsonl:\n            reader = JSONLReader(resource_io)\n        elif format == FormatType.json:\n            reader = JSONReader(resource_io)\n        else:\n            raise ValueError\n\n        for _ in reader:\n            pass\n</code></pre>"},{"location":"Usage/CLI/","title":"<code>koza</code>","text":"<p>Usage:</p> <pre><code>$ koza [OPTIONS] COMMAND [ARGS]...\n</code></pre> <p>Options:</p> <ul> <li><code>--version</code></li> <li><code>--install-completion</code>: Install completion for the current shell.</li> <li><code>--show-completion</code>: Show completion for the current shell, to copy it or customize the installation.</li> <li><code>--help</code>: Show this message and exit.</li> </ul> <p>Commands:</p> <ul> <li><code>transform</code>: Transform a source file</li> <li><code>validate</code>: Validate a source file</li> </ul>"},{"location":"Usage/CLI/#koza-transform","title":"<code>koza transform</code>","text":"<p>Transform a source file</p> <p>Usage:</p> <pre><code>$ koza transform [OPTIONS]\n</code></pre> <p>Options:</p> <ul> <li><code>--source TEXT</code>: Source metadata file  [required]</li> <li><code>--output-dir TEXT</code>: Path to output directory  [default: ./output]</li> <li><code>--output-format [tsv|jsonl|kgx]</code>: Output format  [default: tsv]</li> <li><code>--global-table TEXT</code>: Path to global translation table</li> <li><code>--local-table TEXT</code>: Path to local translation table</li> <li><code>--schema TEXT</code>: Path to schema YAML for validation in writer</li> <li><code>--row-limit INTEGER</code>: Number of rows to process (if skipped, processes entire source file)</li> <li><code>--debug / --quiet</code></li> <li><code>--log / --no-log</code>: Optional log mode - set true to save output to ./logs  [default: no-log]</li> <li><code>--help</code>: Show this message and exit.</li> </ul>"},{"location":"Usage/CLI/#koza-validate","title":"<code>koza validate</code>","text":"<p>Validate a source file</p> <p>Usage:</p> <pre><code>$ koza validate [OPTIONS]\n</code></pre> <p>Options:</p> <ul> <li><code>--file TEXT</code>: Path or url to the source file  [required]</li> <li><code>--format [csv|jsonl|json|yaml|xml]</code>: [default: FormatType.csv]</li> <li><code>--delimiter TEXT</code>: [default: ,]</li> <li><code>--header-delimiter TEXT</code></li> <li><code>--skip-blank-lines / --no-skip-blank-lines</code>: [default: skip-blank-lines]</li> <li><code>--help</code>: Show this message and exit.</li> </ul>"},{"location":"Usage/ingests/","title":"Ingests","text":"<p><sub> (For CLI usage, see the CLI commands page.) </sub> </p> <p>Ingest Overview</p> <p>Koza is designed to process and transform existing data into a target csv/json/jsonl format.  </p> <p>This process is internally known as an ingest. Ingests are defined by:  </p> <ul> <li>Source config yaml: Ingest configuration, including:<ul> <li>metadata, formats, required columns, any SSSOM files, etc. </li> </ul> </li> <li>Map config yaml: (Optional) configures creation of mapping dictionary  </li> <li>Transform code: a Python script, with specific transform instructions </li> </ul> <p>Let's say you have some data, and you want to save certain bits of that data,  with maybe some changes or translations along the way. Creating this ingest will require three things: </p>"},{"location":"Usage/ingests/#1-source-config-file","title":"1. Source Config File","text":"<p>This YAML file sets properties for the ingest of a single file type from a within a Source.</p> Paths are relative to the directory from which you execute Koza. Required properties <code>name</code> Name of the source <code>files</code> List of files to process Optional properties <code>file_archive</code> Path to a file archive containing the files to process <code>format</code> Format of the data file(s) (CSV or JSON) <code>sssom_config</code> Configures usage of SSSOM mapping files <code>depends_on</code> List of map config files to use <code>metadata</code> Metadata for the source <code>transform_code</code> Path to a python file to transform the data <code>transform_mode</code> How to process the transform file <code>global_table</code> Path to a global translation table file <code>local_table</code> Path to a local translation table file <code>filters</code> List of filters to apply <code>json_path</code> Path within JSON object containing data to process <code>required_properties</code> List of properties that must be present in output (JSON only) Optional CSV Specific Properties <code>columns</code> List of columns to include in output (CSV only) <code>delimiter</code> Delimiter for csv files <code>header_delimiter</code> Delimiter for header in csv files <code>header</code> Header row index for csv files <code>comment_char</code> Comment character for csv files <code>skip_blank_lines</code> Skip blank lines in csv files"},{"location":"Usage/ingests/#composing-configuration-from-multiple-yaml-files","title":"Composing Configuration from Multiple Yaml Files","text":"<p>The Koza yaml loader supports importing/including other yaml files with an <code>!include</code> tag.</p> <p>For example, if you had a file named <code>standard-columns.yaml</code>: <pre><code>- 'column_1'\n- 'column_2'\n- 'column_3'\n- 'column_4' : 'int'\n</code></pre></p> <p>Then in any ingests you wish to use these columns, you can simply <code>!include</code> them: <pre><code>columns: !include './path/to/standard-columns.yaml'\n</code></pre></p>"},{"location":"Usage/ingests/#2-mapping-and-additional-data","title":"2. Mapping and Additional Data","text":"<p>Mapping with Koza can be done in two ways:  </p> <ul> <li>Automated mapping with SSSOM files  </li> <li>Manual mapping with a map config yaml</li> </ul>"},{"location":"Usage/ingests/#sssom-mapping","title":"SSSOM Mapping","text":"<p>Koza supports mapping with SSSOM files (Semantic Similarity of Source and Target Ontology Mappings). Simply add the path to the SSSOM file to your source config, the desired target prefixes, and any prefixes you want to use to filter the SSSOM file. Koza will automatically create a mapping lookup table which will automatically attempt to map any values in the source file to an ID with the target prefix.</p> <pre><code>sssom_config:\n    sssom_file: './path/to/your_mapping_file.sssom.tsv'\n    filter_prefixes: \n        - 'SOMEPREFIX'\n        - 'OTHERPREFIX'\n    target_prefixes: \n        - 'OTHERPREFIX'\n    use_match:\n        - 'exact'\n</code></pre> <p>Note: Currently, only the <code>exact</code> match type is supported (<code>narrow</code> and <code>broad</code> match types will be added in the future).</p>"},{"location":"Usage/ingests/#manual-mapping-additional-data","title":"Manual Mapping / Additional Data","text":"<p>The map config yaml allows you to include data from other sources in your ingests, which may have different columns or formats.  </p> <p>If you don't have an SSSOM file, or you want to manually map some values, you can use a map config yaml. You can then add this map to your source config yaml in the <code>depends_on</code> property.  </p> <p>Koza will then create a nested dictionary with the specified key and values. For example, the following map config yaml maps values from the <code>STRING</code> column to the <code>entrez</code> and <code>NCBI taxid</code> columns.</p> <pre><code># koza/examples/maps/entrez-2-string.yaml\nname: ...\nfiles: ...\n\ncolumns:\n- 'NCBI taxid'\n- 'entrez'\n- 'STRING'\n\nkey: 'STRING'\n\nvalues:\n- 'entrez'\n- 'NCBI taxid'\n</code></pre> <p>The mapping dict will be available in your transform script from the <code>koza_app</code> object (see the Transform Code section below).</p>"},{"location":"Usage/ingests/#3-transform-code","title":"3. Transform Code","text":"<p>This Python script is where you'll define the specific steps of your data transformation.  Koza will load this script and execute it for each row of data in your source file, applying any filters and mapping as defined in your source config yaml, and outputting the transformed data to the target csv/json/jsonl file.</p> <p>When Koza is called, either by command-line or as a library using <code>transform_source()</code>, it creates a <code>KozaApp</code> object for the specified ingest. This KozaApp will be your entry point to Koza:</p> <pre><code>from koza.cli_runner import get_koza_app\nkoza_app = get_koza_app('your-source-name')\n</code></pre> <p>The KozaApp object has the following methods:</p> Method Description <code>get_row()</code> Returns the next row of data from the source file <code>get_map(map_name)</code> Returns the mapping dict for the specified map <code>get_global_table()</code> Returns the global translation table <code>get_local_table()</code> Returns the local translation table Example Python Transform Script <pre><code># other imports, eg. uuid, pydantic, etc.\nimport uuid\nfrom biolink.pydanticmodel import Gene, PairwiseGeneToGeneInteraction\n\n# Koza imports\nfrom koza.cli_runner import get_koza_app\n\n# This is the name of the ingest you want to run\nsource_name = 'map-protein-links-detailed'\nkoza_app = get_koza_app(source_name)\n\n# If your ingest depends_on a mapping file, you can access it like this:\nmap_name = 'entrez-2-string'\nkoza_map = koza_app.get_map(map_name)\n\n# This grabs the first/next row from the source data\n# Koza will reload this script and return the next row until it reaches EOF or row-limit\nrow = koza_app.get_row()\n\n# Now you can lay out your actual transformations, and define your output:\n\ngene_a = Gene(id='NCBIGene:' + koza_map[row['protein1']]['entrez'])\ngene_b = Gene(id='NCBIGene:' + koza_map[row['protein2']]['entrez'])\n\npairwise_gene_to_gene_interaction = PairwiseGeneToGeneInteraction(\n    id=\"uuid:\" + str(uuid.uuid1()),\n    subject=gene_a.id,\n    object=gene_b.id,\n    predicate=\"biolink:interacts_with\"\n)\n\n# Finally, write the transformed row to the target file\nkoza_app.write(gene_a, gene_b, pairwise_gene_to_gene_interaction)\n</code></pre>"}]}